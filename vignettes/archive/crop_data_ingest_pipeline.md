---
title: "REPEL Crop Data Ingest Pipeline"
author: "EcoHealth Alliance"
date: "2023-11-29"
output: 
  rmarkdown::html_vignette:
    toc: true
    keep_md: true
vignette: >
  %\VignetteIndexEntry{REPEL Crop Data Ingest Pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



This vignette is an overview of the data ingest pipeline for the crop REPEL model.

# Project setup

## Downloading the repository

The data ingest pipeline can be obtained in two ways.

1.  If you are a collaborator or have permissions within EcoHealth Alliance's GitHub repository for this pipeline, you can access it from the following repository - <https://github.com/ecohealthalliance/repel2> - via the command line.

Using the command line, the pipeline can be obtained either using HTTPS with the following code:

```         
git clone https://github.com/ecohealthalliance/repel2
```

or using SSH with the following code:

```         
git clone git@github.com:ecohealthalliance/repel2.git
```

2.  If you have been provided with a zipped directory of the pipeline repository

To access the pipeline repository, unzip the provided zipped file into a preferred directory in your machine to obtain a directory containing the pipeline.

## Setting environment variables

Some of the data sources require authentication keys to access the data programmatically.
The data ingest pipeline has been set up such that it requires these keys/tokens to be provided as environment variables.
The following keys/tokens are required:

### European and Mediterranean Plant Protection Organization (EPPO) Data Services

EPPO Data Services provides an API to programmatically access the database used for plant disease name standardization.
The API token can be generated by registering for an account at <https://data.eppo.int/user/register>.
Immediately after registration, the token can be copied from the [user dashboard](https://data.eppo.int/user/), under the **Tokens API** header.

### The International Union for Conservation of Nature (IUCN) Red List of Threatened Species API token

The IUCN provides an API to programmatically access the IUCN Red List of Threatened Species.
The required API token can be generated by making a request at <https://apiv3.iucnredlist.org/api/v3/token> detailing the reason for API use.
The request is sent to IUCN and approval along with the API token is provided to the email address used during registration.
This may take several days.

### United Nations Comtrade Database API token/key

The [UN Comtrade Database](https://comtradeplus.un.org/) can be accessed programmatically using its API.
The API token/key can be obtained as follows:

1.  Create a UN Comtrade Database account at this [link](https://unb2c.b2clogin.com/unb2c.onmicrosoft.com/b2c_1a_signup_signin_comtrade/oauth2/v2.0/authorize?client_id=85644091-2534-4703-a6e9-456533d03b2d&scope=openid%20https%3A%2F%2Funb2c.onmicrosoft.com%2Fcomtradeapibe%2Fcomtradeapifunction.write%20profile%20offline_access&redirect_uri=https%3A%2F%2Fcomtradeplus.un.org&client-request-id=3927c60f-62b4-49eb-838e-4a0eff479045&response_mode=fragment&response_type=code&x-client-SKU=msal.js.browser&x-client-VER=2.22.0&x-client-OS=&x-client-CPU=&client_info=1&code_challenge=VHldePVQmSWkhv_iK9_kBjUGPBLlGZA3S9vqiW74wwQ&code_challenge_method=S256&nonce=3905f277-db63-4746-93e7-264cb061b48a&state=eyJpZCI6IjAwNGMzYjU0LWRjMzMtNGNmOC1hOTg4LWUzYzJjNjc3NmU0OCIsIm1ldGEiOnsiaW50ZXJhY3Rpb25UeXBlIjoicmVkaXJlY3QifX0%3D)

2.  Sign in to the [UN Comtrade Database API portal](https://comtradedeveloper.un.org/signin?returnUrl=%2F) and then proceed to the **Products** tab (<https://comtradedeveloper.un.org/products>)

3.  From the **Products** page, select the **Free APIs** option (<https://comtradedeveloper.un.org/product#product=free>)

4.  In the text entry dialog box, enter `comtrade-v1` and then click the `Subscribe` button

After these steps, the page should now show you two subscription keys called primary and secondary which are the API tokens/keys needed for API access.

## Storing environment variables

Once the above-mentioned keys/tokens have been generated/created, they need to be provided as environment variables as follows:

```         
EPPO_TOKEN=YOUR_EPPO_TOKEN_HERE

IUCN_REDLIST_KEY=YOUR_IUCN_REDLIST_KEY_HERE

COMTRADE_PRIMARY=YOUR_COMTRADE_PRIMARY_KEY_HERE
COMTRADE_SECONDARY=YOUR_COMTRADE_SECONDARY_KEY_HERE
```

either manually before running the data ingest pipeline or by creating a `.env` file with the above variables in the root directory of the data ingest pipeline.

## R dependencies

The pipeline was created using R 4.3.0.
This project uses the `{renv}` framework to record R package dependencies and versions.
Packages and versions used are recorded in `renv.lock` and code used to manage dependencies is in `renv/` and other files in the root project directory.
On starting an R session in the working directory, install R package dependencies:

```         
renv::restore()
```

or using the following command in Terminal

```         
Rscript -e 'renv::restore()'
```

## Targets workflow

This pipeline uses the [`targets` package](https://books.ropensci.org/targets/) as  a build system to resolve dependencies and cache results. This is similar conceptually to `make`, with the `_targets.R` file being the equivalent of a `Makefile`.
With `targets`, the user can build individual parts of the pipeline and they will be cached when running in the future.
Target steps can be run in parallel by setting the `NPROC` environment variable to the number of parallel processes desired.

<noscript>

```{=html}
<style>
 .withscript {display:none;}
</style>
```
</noscript>

[This diagram shows all the components of the workflow for the crop data ingest pipeline:]{.withscript}

```{=html}
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<style>.classLabel.label {}</style>
<div class="mermaid withscript" style="width:130%;transform: translateX(-15%);">
graph LR
subgraph identifier[" "]
    direction LR
    xda25e6db09477a7f(["nappo_free_text_scraped"]):::queued --> x2e509948d037bcd1(["nappo_table_processed"]):::queued
    x76e556a1c3d3f1c4(["nappo_table_downloaded"]):::queued --> x2e509948d037bcd1(["nappo_table_processed"]):::queued
    x243e9a3a93bbbd5f(["fao_trade_raw_directory"]):::queued --> x30ce5769aadbedd1(["fao_trade_downloaded"]):::queued
    x8bd51b25e3852859(["ippc_free_text_scraped"]):::queued --> x25d0fa868a10d30a(["ippc_table_processed"]):::queued
    xb5ab79c546ad6d0b(["ippc_table_downloaded"]):::queued --> x25d0fa868a10d30a(["ippc_table_processed"]):::queued
    x55750887a5e59356(["comtrade_crop_download_dates"]):::queued --> xbb8c39253c3f6621(["comtrade_crop_download_end_dates"]):::queued
    x73d6e41d2137a8fa(["fao_production_raw_directory"]):::queued --> xcffe0ecbfdbd9412(["fao_production_downloaded"]):::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued
    x3c68b13c91805251(["comtrade_crop_raw_directory"]):::queued --> xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued
    x85dd99fb5c2dc258(["all_countries_years"]):::queued --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    xa76d84af1df1a18d(["fao_crop_production_item_codes"]):::queued --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    xcffe0ecbfdbd9412(["fao_production_downloaded"]):::queued --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    x62b063f89a2e44b6(["eppo_free_text_processed"]):::queued --> x549ac0068658c458(["eppo_index_processed"]):::queued
    x94904e92a880262a(["eppo_index_downloaded"]):::queued --> x549ac0068658c458(["eppo_index_processed"]):::queued
    x9e9ebbe217ec5311(["eppo_database_downloaded"]):::queued --> x690cfcba8adb0fee(["pest_names_standardized"]):::queued
    x549ac0068658c458(["eppo_index_processed"]):::queued --> x690cfcba8adb0fee(["pest_names_standardized"]):::queued
    x25d0fa868a10d30a(["ippc_table_processed"]):::queued --> x690cfcba8adb0fee(["pest_names_standardized"]):::queued
    x2e509948d037bcd1(["nappo_table_processed"]):::queued --> x690cfcba8adb0fee(["pest_names_standardized"]):::queued
    x0f5d1f6cf0a5d840(["eppo_free_text_scraped"]):::queued --> x62b063f89a2e44b6(["eppo_free_text_processed"]):::queued
    x5baf6c53111a6b90(["all_connect_countries_years"]):::queued --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    xdc77a6b038bec58e(["fao_trade_crop_item_codes"]):::queued --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    x30ce5769aadbedd1(["fao_trade_downloaded"]):::queued --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    x06edd1ed85c2a5ae(["comtrade_crop_commodity_codes"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xbb8c39253c3f6621(["comtrade_crop_download_end_dates"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    x3c68b13c91805251(["comtrade_crop_raw_directory"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    x5baf6c53111a6b90(["all_connect_countries_years"]):::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    x3c68b13c91805251(["comtrade_crop_raw_directory"]):::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    x55750887a5e59356(["comtrade_crop_download_dates"]):::queued --> xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued
    x01c1e17fe0da013c(["crop_report_index"]):::queued --> x79c4525ed5eeb6ef(["crop_disease_data"]):::queued
    x690cfcba8adb0fee(["pest_names_standardized"]):::queued --> x01c1e17fe0da013c(["crop_report_index"]):::queued
  end
classDef default font-size:25px;
</div>
```

## Docker

We have assembled a Docker image with necessary dependencies to run the pipeline, and a convenience shell script (`tar_make.sh`) for building pipeline steps in the console.
To build the image locally and use it to run the pipeline, run the following

```         
docker build . -t ecohealthalliance/repel2
docker run -v "$(pwd):/repel2" ecohealthalliance/repel2 ./tar_make.sh '<TARGET_NAME>'
```

`<TARGET_NAME>` can be any target and can also be `everything()` or other selection commands such `tidyr::contains(c("eppo", "ippc", "nappo"))`.

In addition we have provided a tarball of Docker image.
Instead of building it, you can load it with

```         
docker load < repelcontainer_vXXX.tar.gz
```

# Data ingest and processing

The data ingest pipeline retrieves the datasets used by the REPEL model from their various sources.
These datasets and their respective sources are:

<table class=" lightable-paper" style='font-family: "Arial Narrow", arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;'>
<caption>REPEL datasets with respective data sources</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Name </th>
   <th style="text-align:left;"> Frequency </th>
   <th style="text-align:left;"> Dimension </th>
   <th style="text-align:left;"> Source </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> EPPO plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [European and Mediterranean Plant Protection Organization](https://gd.eppo.int/reporting/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> IPPC plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [International Plant Protection Convention](https://www.ippc.int/en/countries/all/pestreport/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NAPPO plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [North American Plant Protection Organization](https://www.pestalerts.org/nappo/official-pest-reports/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Crop production </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [Food and Agriculture Organization](https://www.fao.org/faostat/en/#data/QCL) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Crop trade </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [Food and Agriculture Organization](https://www.fao.org/faostat/en/#data/TCL) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Other trade (live plants, lumber, and agricultural equipment) </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [United Nations Comtrade Database](https://comtradeplus.un.org/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Gross Domestic Product (GDP) </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [World Bank](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Human population </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [World Bank](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife migration </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [International Union for Conservation of Nature](https://www.iucnredlist.org/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Country shared borders </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [CIA World Factbook archive](https://www.cia.gov/about/archives/download/factbook-2020.zip) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Country distances </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> Calculated between centroids of each country </td>
  </tr>
</tbody>
</table>



Below we provide guidance for testing subsets of the data ingest pipeline.
Note, running `tar_make()` without specifying a target will run all livestock and crop targets.

## Pipeline testing

Given specific requirements (such as API tokens) and length of run times, we recommend the following steps for someone trying out this data ingest and processing pipeline for the first time or for someone reproducing the outputs:

1. Test that the pipeline works as described by running a data source pipeline that doesn't require any tokens

For this purpose, we recommend the pipelines for data retrieved from NAPPO and FAO.
We would expect this pipeline to complete in \~25 minutes.
To run these, the following command can be used in the R console:

```         
targets::tar_make(c(nappo_table_processed, country_yearly_crop_production, connect_yearly_fao_trade_crop))
```

This step will give an indication that the general pipeline works as expected if the run completes without errors.

2. Test the pipeline for a step requiring authentication keys/tokens

The step that requires authentication keys/tokens and completes fast is for data retrieved from COMTRADE.
We would expect this pipeline to complete in \~15 minutes.
To run this, the following command can be used in the R console:

```         
targets::tar_make(connect_yearly_comtrade_crop)
```

This step will test whether you have set up your authentication keys appropriately.

3. Test the remaining pipelines that take longer to run

The steps that require longer run times are for data retrieved from EPPO and IPPC, as well as disease name standardization and taxonomy retrieval.
Depending on server traffic, We would expect this pipeline to complete in 3-5 hours.
To run these, the following command can be used in the R console:

```
targets::tar_make(c(ippc_table_processed, eppo_index_processed, crop_disease_data))
```

## Data storage

The data are stored as follows:

-   all raw data from the various data sources are downloaded and then stored before any processing or standardization inside the `data-raw/` directory; and,
-   all processed data are stored as [qs](https://cran.r-project.org/web/packages/qs/vignettes/vignette.html) files in the `_targets/objects/` directory. We are no longer storing them as csv files because they are an intermediate data product between the raw data and the fully processed model data file. They can still be viewed using `qs::qread("_targets/objects/country_yearly_gdp")` or `targets::tar_read(country_yearly_gdp)`.

Data schemas and descriptions are available as csv files in the `inst/` directory.

-   `inst/data_raw/` contains schemas for the raw downloaded data files

-   `inst/data_dictionary/` contains schemas for the processed data

