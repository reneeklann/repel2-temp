---
title: "REPEL Crop Model Pipeline"
author: "EcoHealth Alliance"
date: "2024-04-05"
output: 
  rmarkdown::html_vignette:
    toc: true
    keep_md: true
vignette: >
  %\VignetteIndexEntry{REPEL Crop Model Pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



This vignette is an overview of the full pipeline for the crop REPEL model, from data ingest and processing to model fitting and predictions.

# Project setup

## Downloading the repository

The project GitHub repository is available at [https://github.com/ecohealthalliance/repel2-battelle](https://github.com/ecohealthalliance/repel2-battelle).

In the terminal, the repository can be cloned using HTTPS:

```         
git clone https://github.com/ecohealthalliance/repel2-battelle
```

or using SSH:

```         
git clone git@github.com:ecohealthalliance/repel2-battelle.git
```

You also have the option of downloading a zipped version of the repository from GitHub. Unzip the file into a preferred directory on your machine.

## Setting environment variables

Environment variables are used to store authentication keys for data sources and to specify model settings. 

Variables can be set manually before running the data ingest pipeline. For example, in R: 

```
Sys.setenv(VARIABLE_NAME = YOUR_VARIABLE_VALUE)
```
However, we suggest storing environmental variables in an `.env` file in the root directory of the repository. This way, environment variables will always be loaded prior to running the pipeline.

### Authentication keys

Some of the data sources require authentication keys to access the data programmatically. The following keys should be saved as environment variables.

```         
IUCN_REDLIST_KEY=YOUR_IUCN_REDLIST_KEY_HERE

COMTRADE_PRIMARY=YOUR_COMTRADE_PRIMARY_KEY_HERE
COMTRADE_SECONDARY=YOUR_COMTRADE_SECONDARY_KEY_HERE

EPPO_TOKEN=YOUR_EPPO_TOKEN_HERE
```
Below we provide instructions for obtaining these keys.

#### The International Union for Conservation of Nature (IUCN) Red List of Threatened Species API token

The IUCN provides an API to programmatically access the IUCN Red List of Threatened Species.
The required API token can be generated by making a request at <https://apiv3.iucnredlist.org/api/v3/token> detailing reason for API use.
Request is sent to IUCN and approval along with the API token is provided to the email address used during registration.
This may take several days.

*Due to delays in obtaining IUCN tokens, the IUCN data file is now saved as part of this data repository. It is no longer necessary to obtain a token to be able to run the pipeline.*

#### United Nations Comtrade Database API token/key

The [UN Comtrade Database](https://comtradeplus.un.org/) can be accessed programmatically using its API.
The API token/key can be obtained as follows:

1.  Create a UN Comtrade Database account at this [link](https://unb2c.b2clogin.com/unb2c.onmicrosoft.com/b2c_1a_signup_signin_comtrade/oauth2/v2.0/authorize?client_id=85644091-2534-4703-a6e9-456533d03b2d&scope=openid%20https%3A%2F%2Funb2c.onmicrosoft.com%2Fcomtradeapibe%2Fcomtradeapifunction.write%20profile%20offline_access&redirect_uri=https%3A%2F%2Fcomtradeplus.un.org&client-request-id=3927c60f-62b4-49eb-838e-4a0eff479045&response_mode=fragment&response_type=code&x-client-SKU=msal.js.browser&x-client-VER=2.22.0&x-client-OS=&x-client-CPU=&client_info=1&code_challenge=VHldePVQmSWkhv_iK9_kBjUGPBLlGZA3S9vqiW74wwQ&code_challenge_method=S256&nonce=3905f277-db63-4746-93e7-264cb061b48a&state=eyJpZCI6IjAwNGMzYjU0LWRjMzMtNGNmOC1hOTg4LWUzYzJjNjc3NmU0OCIsIm1ldGEiOnsiaW50ZXJhY3Rpb25UeXBlIjoicmVkaXJlY3QifX0%3D)

2.  Sign in to the [UN Comtrade Database API portal](https://comtradedeveloper.un.org/signin?returnUrl=%2F) and then proceed to the **Products** tab (<https://comtradedeveloper.un.org/products>)

3.  From the **Products** page, select the **Free APIs** option (<https://comtradedeveloper.un.org/product#product=free>)

4.  In the text entry dialog box, enter `comtrade-v1` and then click the `Subscribe` button

After these steps, the page should now show you two subscription keys called primary and secondary which are the API tokens/keys needed for API access.

#### European and Mediterranean Plant Protection Organization (EPPO) Data Services

EPPO Data Services provides an API to programmatically access the database used for plant disease name standardization.
The API token can be generated by registering for an account at <https://data.eppo.int/user/register>.
Immediately after registration, the token can be copied from the [user dashboard](https://data.eppo.int/user/), under the **Tokens API** header.

### Project settings

In addition to authentication keys, environment variables can be used to store project settings. For example, the user can set the following variables to use AWS for object storage:
```
AWS_REGION=YOUR_AWS_REGION_HERE
AWS_BUCKET_ID=YOUR_AWS_BUCKET_ID_HERE
AWS_ACCESS_KEY_ID=YOUR_AWS_ACCESS_KEY_ID_HERE
AWS_SECRET_ACCESS_KEY=YOUR_AWS_SECRET_ACCESS_KEY_HERE
```

Additional settings related to model fitting and prediction are described in their respective sections below. 

## R dependencies

The pipeline was created using R version 4.3.2 (2023-10-31).
This project uses the `{renv}` framework to record R package dependencies and versions.
Packages and versions used are recorded in `renv.lock` and code used to manage dependencies is in `renv/` and other files in the root project directory.
On starting an R session in the working directory, install R package dependencies:

```         
renv::restore()
```

or using the following command in Terminal

```         
Rscript -e 'renv::restore()'
```

## Targets workflow

This pipeline uses the [`targets` package](https://books.ropensci.org/targets/) as  a build system to resolve dependencies and cache results. This is similar conceptually to `make`, with the `_targets.R` file being the equivalent of a `Makefile`.
With `targets`, the user can build individual parts of the pipeline and they will be cached when running in the future.

<noscript>

```{=html}
<style>
 .withscript {display:none;}
</style>
```
</noscript>

[This diagram shows all the components of the workflow for the crop model:]{.withscript}

- The project is out-of-sync -- use `renv::status()` for details.
```{=html}
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<style>.classLabel.label {}</style>
<div class="mermaid withscript" style="width:130%;transform: translateX(-15%);">
graph LR
subgraph identifier[" "]
    direction LR
    xc30beaa29e1ba2a5(["repel_data_split_crop"]):::queued --> x9bf2ed4c4a26a6ea(["repel_training_data_crop"]):::queued
    xa110dde4636fe557(["repel_predictor_variables_crop"]):::queued --> x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued
    xa0e5b8b4cb4e3791(["repel_training_data_select_crop"]):::queued --> x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued
    x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued --> x33689f5e1dd9c47f(["augmented_crop_data_aggregated_for_prediction"]):::queued
    x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued --> x9ddafe8785777b60(["augmented_crop_data_aggregated"]):::queued
    x73d6e41d2137a8fa(["fao_production_raw_directory"]):::skipped --> xcffe0ecbfdbd9412(["fao_production_downloaded"]):::skipped
    xa110dde4636fe557(["repel_predictor_variables_crop"]):::queued --> x20f74448e7f5b8c7(["repel_validation_data_scaled_crop"]):::queued
    x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued --> x20f74448e7f5b8c7(["repel_validation_data_scaled_crop"]):::queued
    x24311d620ecf862b(["repel_validation_data_crop"]):::queued --> x20f74448e7f5b8c7(["repel_validation_data_scaled_crop"]):::queued
    x68c73920f9c811be(["extracted_data_processed"]):::queued --> xc3d8eecfe08a4a9f(["connect_crop_outbreaks"]):::queued
    x3dcf4c08cbd8badc(["connect_crop_outbreaks_for_prediction"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x9854eeaea882ea7d(["connect_static_shared_borders"]):::skipped --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    xe389dea0f61ca66c(["connect_static_wildlife_migration"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x55e13fd179166880(["country_yearly_crop_production"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x851879d77cc1aec8(["country_yearly_gdp"]):::skipped --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x51fdbcaf7cf24f7c(["country_yearly_human_population"]):::skipped --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x68c73920f9c811be(["extracted_data_processed"]):::queued --> x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued
    x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued --> x898eadd40b49c9c2(["repel_full_crop_pipeline"]):::queued
    x1c4f8bd8c2df89d3(["repel_variable_importance_priority_diseases_usa_crop_plot"]):::queued --> x898eadd40b49c9c2(["repel_full_crop_pipeline"]):::queued
    x06edd1ed85c2a5ae(["comtrade_crop_commodity_codes"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xbb8c39253c3f6621(["comtrade_crop_download_end_dates"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    x3c68b13c91805251(["comtrade_crop_raw_directory"]):::queued --> x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued
    xc3d8eecfe08a4a9f(["connect_crop_outbreaks"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x9854eeaea882ea7d(["connect_static_shared_borders"]):::skipped --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    xe389dea0f61ca66c(["connect_static_wildlife_migration"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x55e13fd179166880(["country_yearly_crop_production"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x851879d77cc1aec8(["country_yearly_gdp"]):::skipped --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x51fdbcaf7cf24f7c(["country_yearly_human_population"]):::skipped --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x68c73920f9c811be(["extracted_data_processed"]):::queued --> x13cc74abe0d55e0d(["augmented_crop_data_disaggregated"]):::queued
    x1c8afbff7cccaa7a(["repel_variable_importance_priority_diseases_usa_crop"]):::queued --> x1c4f8bd8c2df89d3(["repel_variable_importance_priority_diseases_usa_crop_plot"]):::queued
    xdbeb906bed8bdbec(["crop_report_index_file"]):::queued --> x68c73920f9c811be(["extracted_data_processed"]):::queued
    x5221fac474424a4a(["extracted_data"]):::queued --> x68c73920f9c811be(["extracted_data_processed"]):::queued
    x53489fa13cff0c33(["wb_gdp_raw_directory"]):::skipped --> xcc428c9fb8894b63(["wb_gdp_downloaded"]):::skipped
    x5baf6c53111a6b90(["all_connect_countries_years"]):::skipped --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    xdc77a6b038bec58e(["fao_trade_crop_item_codes"]):::queued --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    x30ce5769aadbedd1(["fao_trade_downloaded"]):::queued --> xdacdffe18a15e3b8(["connect_yearly_fao_trade_crop"]):::queued
    x075643de6e2388bd(["repel_calibration_crop"]):::queued --> x15dad95ea11da9d9(["repel_calibration_table_crop"]):::queued
    x5baf6c53111a6b90(["all_connect_countries_years"]):::skipped --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    xeaefd25320133140(["comtrade_crop_download_check"]):::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    x444fcd86db39ceec["comtrade_crop_downloaded"]:::queued --> x3ab0e1efe7a0090b(["connect_yearly_comtrade_crop"]):::queued
    x5ae0e640411e59b4(["augmented_crop_data_disaggregated_for_prediction"]):::queued --> x1c8afbff7cccaa7a(["repel_variable_importance_priority_diseases_usa_crop"]):::queued
    x3c35acea0560d6ca(["repel_model_crop"]):::queued --> x1c8afbff7cccaa7a(["repel_variable_importance_priority_diseases_usa_crop"]):::queued
    x6716da00c1891dcf(["repel_predictions_priority_diseases_usa_crop"]):::queued --> x1c8afbff7cccaa7a(["repel_variable_importance_priority_diseases_usa_crop"]):::queued
    x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued --> x1c8afbff7cccaa7a(["repel_variable_importance_priority_diseases_usa_crop"]):::queued
    xc30beaa29e1ba2a5(["repel_data_split_crop"]):::queued --> x24311d620ecf862b(["repel_validation_data_crop"]):::queued
    x243e9a3a93bbbd5f(["fao_trade_raw_directory"]):::queued --> x30ce5769aadbedd1(["fao_trade_downloaded"]):::queued
    x15dad95ea11da9d9(["repel_calibration_table_crop"]):::queued --> x5e89c9541cdc9445(["repel_calibration_n_within_range_crop"]):::queued
    xb10fa9d73e6fb30a(["repel_validation_predict_crop"]):::queued --> x075643de6e2388bd(["repel_calibration_crop"]):::queued
    x075643de6e2388bd(["repel_calibration_crop"]):::queued --> xa8208c664abcde3c(["repel_calibration_plot_crop"]):::queued
    xa110dde4636fe557(["repel_predictor_variables_crop"]):::queued --> x3c35acea0560d6ca(["repel_model_crop"]):::queued
    x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued --> x3c35acea0560d6ca(["repel_model_crop"]):::queued
    x5baf6c53111a6b90(["all_connect_countries_years"]):::skipped --> x9854eeaea882ea7d(["connect_static_shared_borders"]):::skipped
    xb33c0b84ccf1a185(["shared_borders_downloaded"]):::skipped --> x9854eeaea882ea7d(["connect_static_shared_borders"]):::skipped
    x33689f5e1dd9c47f(["augmented_crop_data_aggregated_for_prediction"]):::queued --> x2cbb7a78996422a8(["repel_predictions_crop"]):::queued
    x3c35acea0560d6ca(["repel_model_crop"]):::queued --> x2cbb7a78996422a8(["repel_predictions_crop"]):::queued
    x3ae7bed7bab000d6(["repel_scaling_values_crop"]):::queued --> x2cbb7a78996422a8(["repel_predictions_crop"]):::queued
    x495a3236f9dd4551(["repel_training_counts_crop"]):::queued --> x2cbb7a78996422a8(["repel_predictions_crop"]):::queued
    x85dd99fb5c2dc258(["all_countries_years"]):::skipped --> x51fdbcaf7cf24f7c(["country_yearly_human_population"]):::skipped
    x50fbb7e5bd89ec49(["wb_human_population_downloaded"]):::skipped --> x51fdbcaf7cf24f7c(["country_yearly_human_population"]):::skipped
    x757711ac4a5f9d39(["groms_migratory_species_directory"]):::queued --> xf9d5a6c8c8407db0(["groms_migratory_species_downloaded"]):::queued
    x85dd99fb5c2dc258(["all_countries_years"]):::skipped --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    xa76d84af1df1a18d(["fao_crop_production_item_codes"]):::queued --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    xcffe0ecbfdbd9412(["fao_production_downloaded"]):::skipped --> x55e13fd179166880(["country_yearly_crop_production"]):::queued
    x5221fac474424a4a(["extracted_data"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x68c73920f9c811be(["extracted_data_processed"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x075643de6e2388bd(["repel_calibration_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x5e89c9541cdc9445(["repel_calibration_n_within_range_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    xa8208c664abcde3c(["repel_calibration_plot_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x15dad95ea11da9d9(["repel_calibration_table_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x413644cfbbdd0a6f(["repel_confusion_matrix_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    xa36b3da4bc786814(["repel_crop_model_updates_report_file"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x3c35acea0560d6ca(["repel_model_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    x9a5bb82d7e756325(["repel_performance_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    xb10fa9d73e6fb30a(["repel_validation_predict_crop"]):::queued --> x34d6e8115fbdbc7e(["repel_crop_model_updates_report"]):::queued
    xa0e5b8b4cb4e3791(["repel_training_data_select_crop"]):::queued --> x495a3236f9dd4551(["repel_training_counts_crop"]):::queued
    x9ddafe8785777b60(["augmented_crop_data_aggregated"]):::queued --> xc30beaa29e1ba2a5(["repel_data_split_crop"]):::queued
    xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued --> xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued
    x3c68b13c91805251(["comtrade_crop_raw_directory"]):::queued --> xef24dbf653228258(["comtrade_crop_downloaded_from_aws"]):::queued
    x2cbb7a78996422a8(["repel_predictions_crop"]):::queued --> x6716da00c1891dcf(["repel_predictions_priority_diseases_usa_crop"]):::queued
    x68c73920f9c811be(["extracted_data_processed"]):::queued --> x3dcf4c08cbd8badc(["connect_crop_outbreaks_for_prediction"]):::queued
    x67bfa82be4ae42f7(["repel_prediction_date_crop"]):::queued --> x3dcf4c08cbd8badc(["connect_crop_outbreaks_for_prediction"]):::queued
    x85dd99fb5c2dc258(["all_countries_years"]):::skipped --> x851879d77cc1aec8(["country_yearly_gdp"]):::skipped
    xcc428c9fb8894b63(["wb_gdp_downloaded"]):::skipped --> x851879d77cc1aec8(["country_yearly_gdp"]):::skipped
    x55750887a5e59356(["comtrade_crop_download_dates"]):::queued --> xea34265e4ef7cb6b(["comtrade_crop_download_start_dates"]):::queued
    xb10fa9d73e6fb30a(["repel_validation_predict_crop"]):::queued --> x413644cfbbdd0a6f(["repel_confusion_matrix_crop"]):::queued
    x3c35acea0560d6ca(["repel_model_crop"]):::queued --> xb10fa9d73e6fb30a(["repel_validation_predict_crop"]):::queued
    x20f74448e7f5b8c7(["repel_validation_data_scaled_crop"]):::queued --> xb10fa9d73e6fb30a(["repel_validation_predict_crop"]):::queued
    x8161bef03a60b37f(["iucn_wildlife_directory"]):::queued --> x36153c67ff369078(["iucn_wildlife_downloaded"]):::queued
    x5baf6c53111a6b90(["all_connect_countries_years"]):::skipped --> xe389dea0f61ca66c(["connect_static_wildlife_migration"]):::queued
    xf9d5a6c8c8407db0(["groms_migratory_species_downloaded"]):::queued --> xe389dea0f61ca66c(["connect_static_wildlife_migration"]):::queued
    x36153c67ff369078(["iucn_wildlife_downloaded"]):::queued --> xe389dea0f61ca66c(["connect_static_wildlife_migration"]):::queued
    x9bf2ed4c4a26a6ea(["repel_training_data_crop"]):::queued --> xa0e5b8b4cb4e3791(["repel_training_data_select_crop"]):::queued
    x7bb7d76675964e9e(["shared_borders_directory"]):::skipped --> xb33c0b84ccf1a185(["shared_borders_downloaded"]):::skipped
    x55750887a5e59356(["comtrade_crop_download_dates"]):::queued --> xbb8c39253c3f6621(["comtrade_crop_download_end_dates"]):::queued
    x39aa2607a72066f2(["wb_human_population_raw_directory"]):::skipped --> x50fbb7e5bd89ec49(["wb_human_population_downloaded"]):::skipped
    x413644cfbbdd0a6f(["repel_confusion_matrix_crop"]):::queued --> x9a5bb82d7e756325(["repel_performance_crop"]):::queued
  end
classDef default font-size:25px;
</div>
```

## Docker

We have assembled a Docker image with necessary dependencies to run the pipeline, and a convenience shell script (`tar_make.sh`) for building pipeline steps in the console.
To build the image locally and use it to run the pipeline, run the following

```         
docker build . -t ecohealthalliance/repel2
docker run -v "$(pwd):/repel2" ecohealthalliance/repel2 ./tar_make.sh '<TARGET_NAME>'
```

`<TARGET_NAME>` can be any target and can also be `everything()` or other selection commands such `tidyr::contains(c("eppo", "ippc", "nappo"))`.

In addition, we have provided a tarball of the Docker image.
Instead of building it, you can load it with

```         
docker load < repelcontainer_vXXX.tar.gz
```

# Data ingest and processing

The data ingest pipeline retrieves the datasets used by the REPEL model from their various sources.
These datasets and their respective sources are:

<table class=" lightable-paper" style='font-family: "Arial Narrow", arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;'>
<caption>REPEL datasets with respective data sources</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Name </th>
   <th style="text-align:left;"> Frequency </th>
   <th style="text-align:left;"> Dimension </th>
   <th style="text-align:left;"> Source </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> EPPO plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [European and Mediterranean Plant Protection Organization](https://gd.eppo.int/reporting/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> IPPC plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [International Plant Protection Convention](https://www.ippc.int/en/countries/all/pestreport/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NAPPO plant pest reports </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [North American Plant Protection Organization](https://www.pestalerts.org/nappo/official-pest-reports/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Crop production </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [Food and Agriculture Organization](https://www.fao.org/faostat/en/#data/QCL) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Crop trade </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [Food and Agriculture Organization](https://www.fao.org/faostat/en/#data/TCL) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Other trade (live plants, lumber, and agricultural equipment) </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [United Nations Comtrade Database](https://comtradeplus.un.org/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Gross Domestic Product (GDP) </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [World Bank](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Human population </td>
   <td style="text-align:left;"> yearly </td>
   <td style="text-align:left;"> per country </td>
   <td style="text-align:left;"> [World Bank](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife migration </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [International Union for Conservation of Nature](https://www.iucnredlist.org/) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Country shared borders </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> [CIA World Factbook archive](https://www.cia.gov/about/archives/download/factbook-2020.zip) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Country distances </td>
   <td style="text-align:left;"> static </td>
   <td style="text-align:left;"> bilateral </td>
   <td style="text-align:left;"> Calculated between centroids of each country </td>
  </tr>
</tbody>
</table>



The entire data ingest and processing pipeline can be run using the following command in the R console.

```         
targets::tar_make(augmented_crop_data_aggregated)
```

or using the following command in Terminal

```         
Rscript -e 'targets::tar_make(augmented_crop_data_aggregated)'
```

The `augmented_crop_data_aggregated` target endpoint is the full model dataset, which combines all predictor and outcome data sources, used for training and validation.
Note that this may take over a day to run due to the data download steps (particularly Comtrade).
Below we provide guidance for testing subsets of the data ingestion pipeline with faster run times.
Note, running `tar_make()` without specifying a target will run all livestock and crop targets.

## Pipeline testing

Given specific requirements (such as API tokens) and length of run times, we recommend the following steps for someone trying out this data ingest and processing pipeline for the first time or for someone reproducing the outputs:

1. Test that the pipeline works as described by running a data source pipeline that doesn't require any tokens

For this purpose, we recommend the pipelines for data retrieved from NAPPO and FAO.
We would expect this pipeline to complete in \~25 minutes.
To run these, the following command can be used in the R console:

```         
targets::tar_make(c(nappo_table_processed, country_yearly_crop_production, connect_yearly_fao_trade_crop))
```

This step will give an indication that the general pipeline works as expected if the run completes without errors.

2. Test the pipeline for a step requiring authentication keys/tokens

The step that requires authentication keys/tokens and completes fast is for data retrieved from the IUCN.
We would expect this pipeline to complete in \~10 minutes.
To run this, the following command can be used in the R console:

```         
targets::tar_make(connect_static_wildlife_migration)
```

This step will test whether you have set up your authentication keys appropriately.

3. Test the remaining pipelines that take longer to run

The steps that require longer run times are for data retrieved from EPPO and IPPC, as well as disease name standardization and taxonomy retrieval.
Depending on server traffic, We would expect this pipeline to complete in 3-5 hours.
To run these, the following command can be used in the R console:

```
targets::tar_make(c(ippc_table_processed, eppo_index_processed, crop_disease_data))
```

4. Run the pipeline for the UN Comtrade database

The remaining source, the UN Comtrade database, requires authentication and also runs the longest (depending on server traffic, could be 2-3 days).
So, we recommend running this last using this command in the R console:

```         
targets::tar_make(connect_yearly_comtrade_crop)
```

**Addressing server errors with the UN Comtrade download pipeline**

The download pipeline for the trade data through the UN Comtrade data API uses authentication keys for a basic individual free subscription.
This type of subscription has specified [rate limits](https://unstats.un.org/wiki/display/comtrade/New+Comtrade+FAQ+for+First+Time+Users#NewComtradeFAQforFirstTimeUsers-Andwhat'sthedownloadcapacityforsubscriptionusers?) which has been taken into account in the pipeline.
However, performing bulk download with a basic individual free subscription is known to infrequently produce `HTTP 500 Internal Server Error`.
To avoid this, UN Comtrade recommends a premium individual or premium institution subscription which allows access to UN Comtrade's bulk API (click [here](https://unstats.un.org/wiki/display/comtrade/New+Comtrade+FAQ+for+First+Time+Users#NewComtradeFAQforFirstTimeUsers-Andwhat'sthedownloadcapacityforsubscriptionusers?) for details on the subscription packages).

The user can prevent these infrequent errors from stopping the full pipeline by setting an environment variable 
```
TARGETS_ERROR="null"
```
Because the Comtrade download pipeline uses dynamic targets branching, this setting allows the pipeline to skip over any failed branches and continue to run subsequent steps using only the data that has been successfully downloaded.
Then, a subsequent call to re-run the pipeline will run the downloads _only_ for the remaining data that have not been downloaded yet.
We recommend re-running the download pipeline at a later time after an `HTTP 500 Internal Server Error` particularly at less busy times (e.g. evenings, weekends).

## Data storage

All raw data from the various data sources are downloaded and then stored before any processing or standardization inside the `data-raw/` directory.

Unless the user has enabled AWS object storage (see Project settings above), all processed data are stored as [qs](https://cran.r-project.org/web/packages/qs/vignettes/vignette.html) files in the `_targets/objects/` directory. 

Data objects can be viewed using the `targets` packages. For example, to view GDP data:

```
targets::tar_read(country_yearly_gdp)
```

Data schemas and descriptions are available as csv files in the `inst/` directory.

-   `inst/data_dictionary_raw.csv` contains schemas for the raw downloaded data files, and

-   `inst/data_dictionary.csv` contains schemas for the processed data

# Model fitting

Data are aggregated to the yearly time scale, such that we are predicting outbreak probabilities using 12-month windows. For example, we predict disease outbreak probability for Jan-Dec 2022 based on conditions in Jan-Dec 2021.

The full dataset is randomly split into training (80%) and validation (20%) data. The training data are scaled and used to fit a linear mixed effects model, with random effects for each disease. 

All elements of the model pipeline can be inspected. This may be especially useful to view the model dataset:

```  
targets::tar_read(augmented_crop_data_aggregated)
```  
Or the model object:

```  
targets::tar_read(repel_model_crop)
```

## Model reports

-   `reports/repel_crop_model_updates.html` presents model results.

## Model retraining

The model was trained and validated on data ending in June 2023. If/when there is a need to refit the model with more recent data, the user can set the maximum training date as an environment variable, with the date in the format yyyy-mm. 

```
CROP_MODEL_MAX_TRAINING_DATE="2023-06"
```

To invalidate the model and refit the model:


1. `tar_invalidate(repel_model_crop)` invalidates the existing model object.

2. Set an environment variable to specify that the model should be refit, otherwise the targets pipeline will skip over the model fitting even when there are upstream data changes.

```
CROP_MODEL_REFIT=TRUE
```

3. `tar_make(repel_full_crop_pipeline)` refits the model, which takes 2 days, and updates predictions and reports.

4. Set the environment variable back to FALSE to prevent the model from refitting when there are data changes.

```
CROP_MODEL_REFIT=FALSE
```

# Model predictions

The target `repel_predictions_crop` provides model predictions for the full dataset, including 12 months ahead from when the data was last updated. 

The target `repel_predictions_priority_diseases_usa_crop` is the output of this function for priority diseases entering the US. 

The target `repel_variable_importance_priority_diseases_usa_crop` contains two data frames pertaining to priority diseases entering the US. `variable_importance` is the importance of each bilateral predictor variable for each month-country-disease prediction. `variable_importance_by_origin` disagreggates the variable importance by outbreak origin countries.

## Updating model predictions

The model can generate predictions for 12 months ahead from when the data was last updated. To update the data, we suggest the following steps:

1. Make a backup of your existing `data-raw` directory.
2. Create an environmental variable to allow COMTRADE data to be redownloaded. This overrides the default time-saving behavior of skipping over files that have already been downloaded.
```
OVERWRITE_COMTRADE_CROP_DOWNLOADED=TRUE
```
3. Run `source("inst/invalidate_crop_pipeline.R")`.
4. Set an environment variable for the current month, as follows. This tells the prediction function how far ahead it can make predictions.

```
CROP_MODEL_LAST_DATA_UPDATE="2023-12"
```  
4. Run `tar_make(repel_full_crop_pipeline)` to rerun the full data download and processing pipeline. Note this will not refit the model unless the user has changed the `CROP_MODEL_REFIT` environment variable (see above).

### Detecting changes in data sources

The workflow has been setup to detect that the data from source has changed and these steps will re-run. For the Comtrade data and the FAO trade and production data specifically, we have noted that during the period of developing this pipeline these data sources changed field names which caused errors. We have now put in place a check system that will detect these changes and provide a more informative error message regarding this during the data processing step and recommends that data processing functions be updated/refactored to adjust for the new field names. For Comtrade specifically, we have put in place a check in the pipeline that runs prior to the start of the Comtrade download step and provides a warning that Comtrade field names have changed. Because the Comtrade download step takes the most time in the pipeline, the data check doesn't stop the pipeline from performing the download but instead gives the warning in advance to allow for updating/refactoring of functions whilst the download is progressing. For all other data, the same checks are performed in case any change happens but for the most part we expect these to remain the same.
